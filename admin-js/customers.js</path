import { db } from "../js/firebase.js";
import {
  collection,
  getDocs,
  deleteDoc,
  doc,
  onSnapshot
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* =======================
   LOAD CUSTOMERS - Realtime List
======================= */
function loadCustomers() {
  const usersRef = collection(db, "users");
  
  onSnapshot(usersRef, (snap) => {
    const list = document.getElementById('customerList');
    const countSpan = document.getElementById('customerCount');
    
    const totalDocs = snap.size;
    countSpan.textContent = `(${totalDocs} ${totalDocs === 1 ? 'customer' : 'customers'})`;
    
    if (snap.empty) {
      list.innerHTML = `
        <div class="empty-state">
          <div class="icon">üë•</div>
          <p>No customers found</p>
        </div>
      `;
      return;
    }

    list.innerHTML = "";

    snap.forEach((d) => {
      const u = d.data();
      const userId = d.id;

      // Get first letter for avatar
      const initial = u.email ? u.email.charAt(0).toUpperCase() : '?';

      const item = document.createElement("div");
      item.className = "customer-item";
      item.onclick = () => showCustomerDetails(userId, u);

      const avatar = document.createElement("div");
      avatar.className = "customer-avatar";
      avatar.textContent = initial;

      const info = document.createElement("div");
      info.className = "customer-info";
      
      const registeredDate = u.createdAt?.toDate 
        ? u.createdAt.toDate().toLocaleDateString() 
        : '‚Äî';
      
      const verifiedLabel = u.emailVerified ? 'Yes' : 'No';
      const verifiedClass = u.emailVerified ? 'yes' : 'no';
      
      info.innerHTML = `
        <div class="email">${u.email || 'No email'}</div>
        <div class="details">
          Registered: ${registeredDate}
          <span class="verified-badge ${verifiedClass}">Verified: ${verifiedLabel}</span>
        </div>
      `;

      const actions = document.createElement("div");
      actions.className = "customer-actions";
      actions.onclick = (e) => e.stopPropagation();

      const viewBtn = document.createElement("button");
      viewBtn.className = "view-btn";
      viewBtn.textContent = "View Orders";
      viewBtn.onclick = (e) => {
        e.stopPropagation();
        viewOrders(userId, u.email);
      };

      actions.appendChild(viewBtn);

      item.appendChild(avatar);
      item.appendChild(info);
      item.appendChild(actions);

      list.appendChild(item);
    });
  });
}

/* =======================
   SHOW CUSTOMER DETAILS
======================= */
function showCustomerDetails(userId, user) {
  // Highlight selected item
  document.querySelectorAll('.customer-item').forEach(item => {
    item.classList.remove('selected');
  });
  
  // Find and select the clicked item by checking onclick content
  const items = document.querySelectorAll('.customer-item');
  items.forEach(item => {
    const onclickAttr = item.getAttribute('onclick') || '';
    if (onclickAttr.includes(userId)) {
      item.classList.add('selected');
    }
  });

  const detailsDiv = document.getElementById('customerDetails');
  const registeredDate = user.createdAt?.toDate 
    ? user.createdAt.toDate().toLocaleString() 
    : '‚Äî';
  
  const lastLogin = user.lastLogin?.toDate 
    ? user.lastLogin.toDate().toLocaleString() 
    : '‚Äî';
  
  const verifiedLabel = user.emailVerified ? 'Yes' : 'No';
  const verifiedClass = user.emailVerified ? 'yes' : 'no';
  
  // Build additional info rows
  let additionalInfo = '';
  
  if (user.name) {
    additionalInfo += `
      <div class="detail-row">
        <label>Full Name</label>
        <div class="detail-value">${user.name}</div>
    `;
  }
  
  if (user.phone) {
    additionalInfo += `
      <div class="detail-row">
        <label>Phone Number</label>
        <div class="detail-value">${user.phone}</div>
    `;
  }
  
  if (user.address) {
    additionalInfo += `
      <div class="detail-row">
        <label>Address</label>
        <div class="detail-value">${user.address}</div>
    `;
  }
  
  if (user.city) {
    additionalInfo += `
      <div class="detail-row">
        <label>City</label>
        <div class="detail-value">${user.city}</div>
    `;
  }
  
  if (user.pincode) {
    additionalInfo += `
      <div class="detail-row">
        <label>Pincode</label>
        <div class="detail-value">${user.pincode}</div>
    `;
  }

  detailsDiv.innerHTML = `
    <!-- Customer Avatar & Basic Info -->
    <div style="text-align: center; margin-bottom: 20px;">
      <div style="width: 80px; height: 80px; background: #8b5cf6; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 32px; font-weight: 600; color: #fff; margin: 0 auto 12px;">
        ${user.email ? user.email.charAt(0).toUpperCase() : '?'}
      </div>
      <h4 style="margin: 0; font-size: 18px; color: #111827;">${user.name || user.email || 'Unknown'}</h4>
      <span class="verified-badge ${verifiedClass}" style="margin-top: 8px;">Email Verified: ${verifiedLabel}</span>
    </div>
    
    <!-- Contact Information -->
    <div class="detail-row">
      <label>Email Address</label>
      <div class="detail-value">${user.email || 'N/A'}</div>
    
    <div class="detail-row">
      <label>User ID</label>
      <div class="detail-value" style="font-size: 11px; word-break: break-all;">${userId}</div>
    
    ${additionalInfo}
    
    <!-- Account Information -->
    <div class="detail-row">
      <label>Registered On</label>
      <div class="detail-value">${registeredDate}</div>
    
    <div class="detail-row">
      <label>Last Login</label>
      <div class="detail-value">${lastLogin}</div>
    
    <!-- Action Buttons -->
    <div class="detail-actions">
      <button onclick="viewOrders('${userId}', '${encodeURIComponent(user.email || '')}')" class="view-btn">
        üìã View Orders
      </button>
      
      <button onclick="deleteCustomer('${userId}')" class="delete-btn">
        üóëÔ∏è Delete
      </button>
    </div>
  `;
  
  // Scroll to details panel on mobile
  if (window.innerWidth < 900) {
    document.querySelector('.customer-details-panel').scrollIntoView({ behavior: 'smooth' });
  }
}

/* =======================
   VIEW ORDERS
======================= */
window.viewOrders = function (userId, email) {
  if (typeof email === 'string') {
    email = decodeURIComponent(email);
  }
  window.location.href = `customer-orders.html?uid=${userId}&email=${encodeURIComponent(email)}`;
};

/* =======================
   DELETE CUSTOMER
======================= */
window.deleteCustomer = async function(userId) {
  if (!confirm('Are you sure you want to delete this customer? This will also remove their data from the database.')) return;

  try {
    await deleteDoc(doc(db, "users", userId));
    alert('Customer deleted successfully');
    
    // Clear details panel
    document.getElementById('customerDetails').innerHTML = `
      <div class="placeholder-message">
        <div class="icon">üëà</div>
        <p>Select a customer from the list to view their details</p>
      </div>
    `;
  } catch(e) {
    console.error(e);
    alert('Failed to delete customer: ' + (e.message || 'Unknown error'));
  }
};

// Initialize
loadCustomers();
